# 테스트 자동화 가이드

## 목차
1. [개요](#개요)
2. [Django 백엔드 테스트](#django-백엔드-테스트)
3. [React 프론트엔드 테스트](#react-프론트엔드-테스트)
4. [Flask ML API 테스트](#flask-ml-api-테스트)
5. [E2E 테스트](#e2e-테스트)
6. [CI/CD 통합](#cicd-통합)
7. [테스트 커버리지](#테스트-커버리지)

---

## 개요

### 테스트 피라미드

```
           /\
          /E2E\          < 10% (통합 테스트)
         /------\
        /  API   \       < 20% (API 테스트)
       /----------\
      /    Unit    \     < 70% (단위 테스트)
     /--------------\
```

### 테스트 목표

- 단위 테스트 커버리지 > 80%
- API 테스트 커버리지 > 60%
- 주요 사용자 플로우 E2E 테스트
- CI/CD 파이프라인 통합

---

## Django 백엔드 테스트

### 1. 테스트 설정

```python
# backend/django_main/neuronova/settings_test.py

from .settings import *

# 테스트용 데이터베이스
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': ':memory:',  # 메모리 DB (빠름)
    }
}

# 캐시 비활성화
CACHES = {
    'default': {
        'BACKEND': 'django.core.cache.backends.dummy.DummyCache',
    }
}

# 비밀번호 해싱 단순화 (테스트 속도 향상)
PASSWORD_HASHERS = [
    'django.contrib.auth.hashers.MD5PasswordHasher',
]

# 이메일 백엔드
EMAIL_BACKEND = 'django.core.mail.backends.locmem.EmailBackend'

# 미디어 파일
MEDIA_ROOT = '/tmp/neuronova_test_media'

# 로깅 최소화
LOGGING = {
    'version': 1,
    'disable_existing_loggers': True,
}
```

### 2. 단위 테스트 (Unit Tests)

#### 모델 테스트

```python
# backend/django_main/apps/emr/tests/test_models.py

from django.test import TestCase
from django.contrib.auth.models import User
from apps.emr.models import Patient, Encounter
from datetime import date


class PatientModelTest(TestCase):
    """환자 모델 테스트"""

    def setUp(self):
        """테스트 데이터 설정"""
        self.user = User.objects.create_user(
            username='testpatient',
            password='testpass123'
        )

        self.patient = Patient.objects.create(
            user=self.user,
            date_of_birth=date(1990, 1, 1),
            gender='M',
            phone='010-1234-5678'
        )

    def test_patient_creation(self):
        """환자 생성 테스트"""
        self.assertEqual(self.patient.user.username, 'testpatient')
        self.assertEqual(self.patient.gender, 'M')
        self.assertTrue(self.patient.is_active)

    def test_patient_age_calculation(self):
        """나이 계산 테스트"""
        age = self.patient.calculate_age()
        self.assertGreater(age, 0)
        self.assertLess(age, 150)

    def test_patient_str_representation(self):
        """문자열 표현 테스트"""
        patient_str = str(self.patient)
        self.assertIn('testpatient', patient_str)

    def test_patient_soft_delete(self):
        """소프트 삭제 테스트"""
        self.patient.soft_delete()
        self.assertFalse(self.patient.is_active)
        self.assertIsNotNone(self.patient.deleted_at)

    def tearDown(self):
        """테스트 데이터 정리"""
        self.patient.delete()
        self.user.delete()
```

#### API 뷰 테스트

```python
# backend/django_main/apps/emr/tests/test_views.py

from rest_framework.test import APITestCase, APIClient
from rest_framework import status
from django.contrib.auth.models import User
from apps.emr.models import Patient


class PatientAPITest(APITestCase):
    """환자 API 테스트"""

    def setUp(self):
        """테스트 클라이언트 및 사용자 설정"""
        self.client = APIClient()

        # 테스트 사용자 생성
        self.user = User.objects.create_user(
            username='doctor',
            password='testpass123'
        )

        # 인증
        self.client.force_authenticate(user=self.user)

    def test_get_patient_list(self):
        """환자 목록 조회 테스트"""
        response = self.client.get('/api/emr/patients/')

        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertIsInstance(response.data, list)

    def test_create_patient(self):
        """환자 생성 테스트"""
        # 환자용 사용자 생성
        patient_user = User.objects.create_user(
            username='newpatient',
            password='testpass123'
        )

        data = {
            'user': patient_user.id,
            'date_of_birth': '1990-01-01',
            'gender': 'F',
            'phone': '010-9999-8888'
        }

        response = self.client.post('/api/emr/patients/', data)

        self.assertEqual(response.status_code, status.HTTP_201_CREATED)
        self.assertEqual(Patient.objects.count(), 1)

    def test_get_patient_detail(self):
        """환자 상세 조회 테스트"""
        # 테스트 환자 생성
        patient_user = User.objects.create_user(
            username='patient1',
            password='testpass123'
        )

        patient = Patient.objects.create(
            user=patient_user,
            date_of_birth='1990-01-01',
            gender='M'
        )

        response = self.client.get(f'/api/emr/patients/{patient.id}/')

        self.assertEqual(response.status_code, status.HTTP_200_OK)
        self.assertEqual(response.data['gender'], 'M')

    def test_unauthorized_access(self):
        """인증 없이 접근 테스트"""
        self.client.force_authenticate(user=None)  # 인증 해제

        response = self.client.get('/api/emr/patients/')

        self.assertEqual(response.status_code, status.HTTP_401_UNAUTHORIZED)

    def tearDown(self):
        """테스트 데이터 정리"""
        Patient.objects.all().delete()
        User.objects.all().delete()
```

#### 서비스 로직 테스트

```python
# backend/django_main/apps/core/tests/test_services.py

from django.test import TestCase
from unittest.mock import patch, MagicMock
from apps.core.services.external_api import external_api


class ExternalAPIServiceTest(TestCase):
    """외부 API 서비스 테스트"""

    @patch('apps.core.services.external_api.requests.get')
    def test_drugbank_api_call(self, mock_get):
        """DrugBank API 호출 테스트 (Mock)"""

        # Mock 응답 설정
        mock_response = MagicMock()
        mock_response.status_code = 200
        mock_response.json.return_value = {
            'drugbank_id': 'DB00001',
            'name': 'Aspirin'
        }
        mock_get.return_value = mock_response

        # API 호출
        result = external_api.call_drugbank('/drugs/DB00001')

        # 검증
        self.assertEqual(result['name'], 'Aspirin')
        mock_get.assert_called_once()

    @patch('apps.core.services.external_api.requests.get')
    def test_drugbank_api_error_handling(self, mock_get):
        """DrugBank API 에러 처리 테스트"""

        # Mock 에러 응답
        mock_response = MagicMock()
        mock_response.status_code = 401
        mock_get.return_value = mock_response

        # API 호출 및 예외 확인
        from apps.core.services.external_api import APIAuthenticationError

        with self.assertRaises(APIAuthenticationError):
            external_api.call_drugbank('/drugs/DB00001')
```

### 3. 테스트 실행

```bash
# 모든 테스트 실행
cd ~/NeuroNova/backend/django_main
python manage.py test --settings=neuronova.settings_test

# 특정 앱 테스트
python manage.py test apps.emr --settings=neuronova.settings_test

# 특정 테스트 클래스
python manage.py test apps.emr.tests.test_models.PatientModelTest

# 특정 테스트 메소드
python manage.py test apps.emr.tests.test_models.PatientModelTest.test_patient_creation

# 병렬 실행 (빠름)
python manage.py test --parallel --settings=neuronova.settings_test

# 커버리지와 함께 실행
coverage run --source='.' manage.py test --settings=neuronova.settings_test
coverage report
coverage html  # HTML 리포트 생성
```

---

## React 프론트엔드 테스트

### 1. 테스트 라이브러리 설치

```bash
cd ~/NeuroNova/frontend/react_web

# Jest, React Testing Library 설치
npm install --save-dev @testing-library/react @testing-library/jest-dom @testing-library/user-event
```

### 2. 컴포넌트 테스트

```javascript
// frontend/react_web/src/components/common/__tests__/LoadingSpinner.test.jsx

import { render, screen } from '@testing-library/react';
import '@testing-library/jest-dom';
import LoadingSpinner from '../LoadingSpinner';

describe('LoadingSpinner', () => {
  test('renders with default props', () => {
    render(<LoadingSpinner />);

    const spinner = screen.getByRole('status', { hidden: true });
    expect(spinner).toBeInTheDocument();
  });

  test('displays custom message', () => {
    render(<LoadingSpinner message="데이터 로딩 중..." />);

    expect(screen.getByText('데이터 로딩 중...')).toBeInTheDocument();
  });

  test('renders in fullscreen mode', () => {
    const { container } = render(<LoadingSpinner fullScreen={true} />);

    const fullscreenDiv = container.querySelector('.loading-fullscreen');
    expect(fullscreenDiv).toBeInTheDocument();
  });

  test('renders different sizes', () => {
    const { container: smallContainer } = render(<LoadingSpinner size="small" />);
    expect(smallContainer.querySelector('.spinner-small')).toBeInTheDocument();

    const { container: largeContainer } = render(<LoadingSpinner size="large" />);
    expect(largeContainer.querySelector('.spinner-large')).toBeInTheDocument();
  });
});
```

### 3. 서비스/API 테스트

```javascript
// frontend/react_web/src/services/__tests__/apiClient.test.js

import { apiGet, apiPost, APIError, handleAPIResponse } from '../apiClient';

// Fetch API 모킹
global.fetch = jest.fn();

describe('API Client', () => {
  beforeEach(() => {
    fetch.mockClear();
    localStorage.clear();
  });

  test('apiGet sends correct request', async () => {
    const mockResponse = { data: 'test' };

    fetch.mockResolvedValueOnce({
      ok: true,
      status: 200,
      json: async () => mockResponse
    });

    const result = await apiGet('/api/test');

    expect(result).toEqual(mockResponse);
    expect(fetch).toHaveBeenCalledWith(
      '/api/test',
      expect.objectContaining({
        method: 'GET',
        headers: expect.objectContaining({
          'Content-Type': 'application/json'
        })
      })
    );
  });

  test('apiPost sends data correctly', async () => {
    const mockData = { name: 'Test' };
    const mockResponse = { id: 1, ...mockData };

    fetch.mockResolvedValueOnce({
      ok: true,
      status: 201,
      json: async () => mockResponse
    });

    const result = await apiPost('/api/test', mockData);

    expect(result).toEqual(mockResponse);
    expect(fetch).toHaveBeenCalledWith(
      '/api/test',
      expect.objectContaining({
        method: 'POST',
        body: JSON.stringify(mockData)
      })
    );
  });

  test('handleAPIResponse throws APIError on 404', async () => {
    const mockResponse = {
      ok: false,
      status: 404,
      json: async () => ({ error: 'Not found' })
    };

    await expect(handleAPIResponse(mockResponse)).rejects.toThrow(APIError);
  });

  test('apiGet includes auth token if available', async () => {
    localStorage.setItem('access_token', 'test-token');

    fetch.mockResolvedValueOnce({
      ok: true,
      json: async () => ({})
    });

    await apiGet('/api/test');

    expect(fetch).toHaveBeenCalledWith(
      '/api/test',
      expect.objectContaining({
        headers: expect.objectContaining({
          'Authorization': 'Bearer test-token'
        })
      })
    );
  });
});
```

### 4. 테스트 실행

```bash
# 모든 테스트 실행
npm test

# 커버리지와 함께
npm test -- --coverage

# Watch 모드 (개발 중)
npm test -- --watch

# 특정 테스트 파일만
npm test LoadingSpinner.test.jsx
```

---

## Flask ML API 테스트

### 1. 테스트 설정

```python
# backend/flask_ml/tests/conftest.py

import pytest
from app import create_app


@pytest.fixture
def app():
    """Flask 앱 픽스처"""
    app = create_app('testing')

    yield app


@pytest.fixture
def client(app):
    """테스트 클라이언트"""
    return app.test_client()


@pytest.fixture
def auth_headers():
    """인증 헤더"""
    return {
        'X-Service-Key': 'test-service-key'
    }
```

### 2. API 엔드포인트 테스트

```python
# backend/flask_ml/tests/test_api.py

import pytest
import json


def test_health_check(client):
    """헬스 체크 테스트"""
    response = client.get('/health')

    assert response.status_code == 200
    assert response.json['status'] == 'healthy'


def test_predict_unauthorized(client):
    """인증 없이 예측 요청 테스트"""
    response = client.post('/api/predict')

    assert response.status_code == 401


def test_predict_with_valid_data(client, auth_headers):
    """정상 데이터로 예측 요청 테스트"""
    data = {
        'image_data': 'base64-encoded-image',
        'model_type': 'xray_pneumonia'
    }

    response = client.post(
        '/api/predict',
        data=json.dumps(data),
        headers={
            **auth_headers,
            'Content-Type': 'application/json'
        }
    )

    assert response.status_code == 200
    assert 'prediction' in response.json


def test_predict_with_invalid_data(client, auth_headers):
    """잘못된 데이터로 예측 요청 테스트"""
    data = {
        'image_data': 'invalid-data'
    }

    response = client.post(
        '/api/predict',
        data=json.dumps(data),
        headers={
            **auth_headers,
            'Content-Type': 'application/json'
        }
    )

    assert response.status_code == 400
```

### 3. ML 모델 테스트

```python
# backend/flask_ml/tests/test_models.py

import pytest
import numpy as np
from ml_models.xray_classifier import XRayClassifier


@pytest.fixture
def classifier():
    """XRay 분류기 픽스처"""
    return XRayClassifier()


def test_model_load(classifier):
    """모델 로드 테스트"""
    assert classifier.model is not None


def test_prediction(classifier):
    """예측 테스트"""
    # 테스트 이미지 (랜덤)
    test_image = np.random.rand(224, 224, 3)

    result = classifier.predict(test_image)

    assert 'class' in result
    assert 'confidence' in result
    assert 0 <= result['confidence'] <= 1
```

---

## E2E 테스트

### 1. Playwright 설정

```bash
# Playwright 설치
cd ~/NeuroNova
npm install --save-dev @playwright/test
npx playwright install
```

```javascript
// playwright.config.js

import { defineConfig } from '@playwright/test';

export default defineConfig({
  testDir: './tests/e2e',
  use: {
    baseURL: 'http://localhost:3000',
    screenshot: 'only-on-failure',
    video: 'retain-on-failure',
  },
  projects: [
    { name: 'chromium', use: { browserName: 'chromium' } },
    { name: 'firefox', use: { browserName: 'firefox' } },
  ],
});
```

### 2. E2E 테스트 작성

```javascript
// tests/e2e/patient-registration.spec.js

import { test, expect } from '@playwright/test';

test.describe('환자 등록 플로우', () => {
  test('간호사가 환자를 등록할 수 있다', async ({ page }) => {
    // 로그인
    await page.goto('/login');
    await page.fill('[name="username"]', 'nurse');
    await page.fill('[name="password"]', 'testpass');
    await page.click('button[type="submit"]');

    // 대시보드로 이동 확인
    await expect(page).toHaveURL('/dashboard');

    // 환자 등록 페이지로 이동
    await page.click('text=환자 등록');
    await expect(page).toHaveURL('/admin/patient-registration');

    // 환자 정보 입력
    await page.fill('[name="first_name"]', '홍');
    await page.fill('[name="last_name"]', '길동');
    await page.fill('[name="phone"]', '010-1234-5678');
    await page.fill('[name="date_of_birth"]', '1990-01-01');
    await page.selectOption('[name="gender"]', 'M');

    // 등록 버튼 클릭
    await page.click('button:has-text("등록")');

    // 성공 메시지 확인
    await expect(page.locator('.toast-success')).toBeVisible();
  });
});
```

### 3. E2E 테스트 실행

```bash
# 모든 E2E 테스트 실행
npx playwright test

# UI 모드 (시각적)
npx playwright test --ui

# 특정 브라우저만
npx playwright test --project=chromium

# 리포트 보기
npx playwright show-report
```

---

## CI/CD 통합

### GitHub Actions 워크플로우

```yaml
# .github/workflows/test.yml

name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  backend-tests:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: testpass
          MYSQL_DATABASE: test_db
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          cd backend/django_main
          pip install -r requirements.txt

      - name: Run Django tests
        run: |
          cd backend/django_main
          coverage run --source='.' manage.py test --settings=neuronova.settings_test
          coverage report
          coverage xml

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3

  frontend-tests:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          cd frontend/react_web
          npm ci

      - name: Run React tests
        run: |
          cd frontend/react_web
          npm test -- --coverage --watchAll=false

  e2e-tests:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright
        run: npx playwright install --with-deps

      - name: Run E2E tests
        run: npx playwright test

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: playwright-report
          path: playwright-report/
```

---

## 테스트 커버리지

### 커버리지 목표

```
Component          | Target Coverage
-------------------|----------------
Models             | > 90%
Views/API          | > 80%
Services           | > 85%
Utils              | > 75%
React Components   | > 70%
```

### 커버리지 리포트 확인

```bash
# Django
cd backend/django_main
coverage html
open htmlcov/index.html

# React
cd frontend/react_web
npm test -- --coverage
open coverage/lcov-report/index.html
```

---

**문서 버전**: 1.0
**최종 수정일**: 2025-12-07
**작성자**: NeuroNova 개발팀
