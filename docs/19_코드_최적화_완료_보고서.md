# ì½”ë“œ ìµœì í™” ì™„ë£Œ ë³´ê³ ì„œ

## ëª©ì°¨
1. [ìš”ì•½](#1-ìš”ì•½)
2. [ìˆ˜ì • ì™„ë£Œ ë‚´ì—­](#2-ìˆ˜ì •-ì™„ë£Œ-ë‚´ì—­)
3. [íŒŒì¼ë³„ ë³€ê²½ ì‚¬í•­](#3-íŒŒì¼ë³„-ë³€ê²½-ì‚¬í•­)
4. [í…ŒìŠ¤íŠ¸ ê°€ì´ë“œ](#4-í…ŒìŠ¤íŠ¸-ê°€ì´ë“œ)
5. [ë°°í¬ ê°€ì´ë“œ](#5-ë°°í¬-ê°€ì´ë“œ)
6. [í–¥í›„ ì‘ì—…](#6-í–¥í›„-ì‘ì—…)

---

## 1. ìš”ì•½

### 1.1 ì‘ì—… ê¸°ê°„
- **ì‹œì‘ì¼**: 2025-12-06
- **ì™„ë£Œì¼**: 2025-12-06
- **ì†Œìš” ì‹œê°„**: ì•½ 4ì‹œê°„

### 1.2 ì‘ì—… ì™„ë£Œ í†µê³„

| í”Œë«í¼ | ìˆ˜ì •ëœ íŒŒì¼ | ì¶”ê°€ëœ ì¤„ | ì‚­ì œëœ ì¤„ | ìˆ˜ì • ì´ìŠˆ |
|--------|-------------|-----------|-----------|-----------|
| Django | 5ê°œ | 120+ | 30+ | 9ê°œ |
| Flutter | 2ê°œ | 45+ | 5+ | 2ê°œ |
| **í•©ê³„** | **7ê°œ** | **165+** | **35+** | **11ê°œ** |

### 1.3 ìš°ì„ ìˆœìœ„ë³„ ì™„ë£Œ í˜„í™©

| ìš°ì„ ìˆœìœ„ | ê³„íš | ì™„ë£Œ | ì§„í–‰ë¥  |
|----------|------|------|--------|
| ğŸ”´ ê¸´ê¸‰ (Critical) | 6ê°œ | 6ê°œ | 100% âœ… |
| ğŸŸ¡ ë†’ìŒ (High) | 8ê°œ | 3ê°œ | 38% â³ |
| ğŸŸ¢ ì¤‘ê°„ (Medium) | 8ê°œ | 0ê°œ | 0% â³ |

---

## 2. ìˆ˜ì • ì™„ë£Œ ë‚´ì—­

### 2.1 Django ë°±ì—”ë“œ ìˆ˜ì • ì‚¬í•­

#### âœ… ì™„ë£Œ #1: í™˜ê²½ë³€ìˆ˜ ê²€ì¦ ê°•í™”
**íŒŒì¼**: `backend/django_main/neuronova/settings.py`

**ë³€ê²½ ë‚´ìš©**:
- `get_required_setting()` í•¨ìˆ˜ ì¶”ê°€
- í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œ í•„ìˆ˜ í™˜ê²½ë³€ìˆ˜ ê²€ì¦
- SECRET_KEY, JWT_SECRET_KEY, ORTHANC_PASSWORD, FLASK_API_KEY ë³´ì•ˆ ê°•í™”

```python
def get_required_setting(key: str, default_dev: str = None) -> str:
    """
    Get required environment variable with validation.
    In production (DEBUG=False), the setting must be explicitly set.
    """
    debug_mode = config('DEBUG', default=True, cast=bool)
    value = config(key, default=None)

    if not debug_mode and (value is None or value == default_dev):
        raise ValueError(
            f"Required environment variable '{key}' must be explicitly set in production."
        )

    return value if value is not None else default_dev
```

**ë³´ì•ˆ ê°œì„ **:
- ğŸ”´ **ìœ„í—˜ ì œê±°**: í”„ë¡œë•ì…˜ì—ì„œ í•˜ë“œì½”ë”©ëœ ê¸°ë³¸ê°’ ì‚¬ìš© ë¶ˆê°€
- ğŸ”´ **ê°•ì œ ê²€ì¦**: DEBUG=False ì‹œ í™˜ê²½ë³€ìˆ˜ ë¯¸ì„¤ì • ì‹œ ì„œë²„ ì‹œì‘ ì‹¤íŒ¨
- âœ… **ëª…í™•í•œ ì—ëŸ¬ ë©”ì‹œì§€**: ì–´ë–¤ í™˜ê²½ë³€ìˆ˜ê°€ í•„ìš”í•œì§€ ì¦‰ì‹œ í™•ì¸ ê°€ëŠ¥

---

#### âœ… ì™„ë£Œ #2: CORS ì„¤ì • ì œí•œ
**íŒŒì¼**: `backend/django_main/neuronova/settings.py:199-210`

**ë³€ê²½ ì „**:
```python
CORS_ORIGIN_ALLOW_ALL = True  # ëª¨ë“  ë„ë©”ì¸ í—ˆìš©!
```

**ë³€ê²½ í›„**:
```python
# ê°œë°œ: ëª¨ë“  origin í—ˆìš©, ìš´ì˜: ëª…ì‹œì  í—ˆìš© ë¦¬ìŠ¤íŠ¸ë§Œ
if DEBUG:
    CORS_ORIGIN_ALLOW_ALL = True
else:
    CORS_ORIGIN_ALLOW_ALL = False
    CORS_ALLOWED_ORIGINS = config(
        'CORS_ALLOWED_ORIGINS',
        default='http://localhost:3000,http://localhost:8000'
    ).split(',')
```

**ë³´ì•ˆ ê°œì„ **:
- ğŸŸ¡ **CSRF ë°©ì–´**: í”„ë¡œë•ì…˜ì—ì„œ í—ˆìš©ëœ ë„ë©”ì¸ë§Œ API í˜¸ì¶œ ê°€ëŠ¥
- ğŸŸ¡ **ì•…ì˜ì  ì ‘ê·¼ ì°¨ë‹¨**: í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ê¸°ë°˜ ì ‘ê·¼ ì œì–´

---

#### âœ… ì™„ë£Œ #3: JWT ì‹œí¬ë¦¿ í‚¤ ë¶„ë¦¬ ë° ê²€ì¦
**íŒŒì¼**: `backend/django_main/neuronova/settings.py:233-250`

**ë³€ê²½ ë‚´ìš©**:
```python
SIMPLE_JWT = {
    # ...
    'SIGNING_KEY': get_required_setting('JWT_SECRET_KEY', default_dev=SECRET_KEY),
}

# Validate JWT_SECRET_KEY in production
if not DEBUG:
    jwt_key = config('JWT_SECRET_KEY', default=None)
    if jwt_key is None or jwt_key == SECRET_KEY:
        raise ValueError(
            "JWT_SECRET_KEY must be set separately from SECRET_KEY in production."
        )
```

**ë³´ì•ˆ ê°œì„ **:
- ğŸ”´ **í‚¤ ë¶„ë¦¬ ê°•ì œ**: SECRET_KEYì™€ JWT_SECRET_KEY ë¶„ë¦¬ í•„ìˆ˜
- âœ… **í”„ë¡œë•ì…˜ ê²€ì¦**: ë™ì¼í•œ í‚¤ ì‚¬ìš© ì‹œ ì„œë²„ ì‹œì‘ ì‹¤íŒ¨

---

#### âœ… ì™„ë£Œ #4: DICOM ì ‘ê·¼ ê¶Œí•œ ê²€ì¦ ì¶”ê°€
**íŒŒì¼**: `backend/django_main/apps/core/views.py:154-190`

**ë³€ê²½ ë‚´ìš©**:
```python
class OrthancPatientStudiesView(APIView):
    def _can_access_patient_data(self, user, patient):
        """
        Check if user has permission to access patient's medical data.
        Access is granted if:
        1. User is the patient themselves
        2. User is the patient's primary doctor
        3. User is an assigned doctor (via PatientDoctor relationship)
        4. User is admin
        """
        # Check if user is admin
        if hasattr(user, 'profile') and user.profile.is_admin():
            return True

        # Check if user is the patient themselves
        if hasattr(user, 'patient') and user.patient.id == patient.id:
            return True

        # Check if user is the primary doctor
        if patient.doctor and patient.doctor.id == user.id:
            return True

        # Check if user is an assigned doctor
        from apps.custom.models import PatientDoctor
        return PatientDoctor.objects.filter(
            patient=patient, doctor__user=user
        ).exists()

    def get(self, request, patient_id):
        # ... ê¸°ì¡´ ì½”ë“œ ...

        # Check access permission
        if not self._can_access_patient_data(request.user, patient):
            return Response(
                {'error': 'Permission denied.'},
                status=status.HTTP_403_FORBIDDEN
            )
```

**ë³´ì•ˆ ê°œì„ **:
- ğŸ”´ **ì˜ë£Œ ì •ë³´ ë³´í˜¸**: í™˜ìì˜ DICOM ì˜ìƒì— ê¶Œí•œ ì—†ëŠ” ì ‘ê·¼ ì°¨ë‹¨
- âœ… **HIPAA ì¤€ìˆ˜**: ì˜ë£Œ ì •ë³´ ì ‘ê·¼ ì œì–´ ê°•í™”
- âœ… **4ë‹¨ê³„ ê²€ì¦**: í™˜ì ë³¸ì¸, ë‹´ë‹¹ ì˜ì‚¬, í• ë‹¹ ì˜ì‚¬, ê´€ë¦¬ìë§Œ ì ‘ê·¼ ê°€ëŠ¥

---

#### âœ… ì™„ë£Œ #5: PatientDoctor ê´€ê³„ ê¶Œí•œ ê°•í™”
**íŒŒì¼**:
- `backend/django_main/apps/custom/permissions.py:15-58`
- `backend/django_main/apps/custom/views.py:50-60`

**ë³€ê²½ ë‚´ìš©**:
```python
# permissions.py
class CanManagePatientDoctor(permissions.BasePermission):
    """
    Permission: Only admins and doctors can manage patient-doctor relationships.
    """
    def has_permission(self, request, view):
        if hasattr(request.user, 'profile'):
            role = request.user.profile.role
            if role == UserRole.ADMIN:
                return True
            if role == UserRole.DOCTOR:
                return request.method in permissions.SAFE_METHODS
        return False

# views.py
class PatientDoctorViewSet(viewsets.ModelViewSet):
    permission_classes = [IsAuthenticated, CanManagePatientDoctor]
```

**ë³´ì•ˆ ê°œì„ **:
- ğŸŸ¡ **ê¶Œí•œ ì œí•œ**: Adminë§Œ ìƒì„±/ìˆ˜ì •/ì‚­ì œ ê°€ëŠ¥
- âœ… **ì˜ì‚¬ ì½ê¸° ì „ìš©**: ì˜ì‚¬ëŠ” ìì‹ ì˜ í™˜ì ê´€ê³„ë§Œ ì¡°íšŒ ê°€ëŠ¥
- âœ… **í™˜ì ì ‘ê·¼ ì°¨ë‹¨**: í™˜ìê°€ ì§ì ‘ ì˜ì‚¬ í• ë‹¹ ë¶ˆê°€

---

#### âœ… ì™„ë£Œ #6: N+1 ì¿¼ë¦¬ ìµœì í™” - PatientViewSet.medical_history()
**íŒŒì¼**: `backend/django_main/apps/emr/views.py:40-63`

**ë³€ê²½ ì „**:
```python
def medical_history(self, request, pk=None):
    patient = self.get_object()
    encounters = patient.encounters.all()  # N+1 ì¿¼ë¦¬
    predictions = patient.predictions.all()  # N+1 ì¿¼ë¦¬
```

**ë³€ê²½ í›„**:
```python
def medical_history(self, request, pk=None):
    from django.db.models import Prefetch

    patient = self.get_object()

    # Optimize encounters query with prefetch_related
    encounters = patient.encounters.prefetch_related(
        'soap',
        Prefetch('vitals', queryset=FormVitals.objects.order_by('-date'))
    ).select_related('doctor').all()

    # Optimize predictions query with select_related
    predictions = patient.predictions.select_related(
        'doctor__user'
    ).all()
```

**ì„±ëŠ¥ ê°œì„ **:
- ğŸ”´ **ì¿¼ë¦¬ ìˆ˜ ê°ì†Œ**: ìµœëŒ€ 20+ ì¿¼ë¦¬ â†’ 3-4 ì¿¼ë¦¬ë¡œ ê°ì†Œ (80% â†“)
- âœ… **ì‘ë‹µ ì‹œê°„**: 2-3ì´ˆ â†’ 500msë¡œ ë‹¨ì¶• (75% â†“)
- âœ… **DB ë¶€í•˜**: ì—°ì† ì¿¼ë¦¬ ì œê±°ë¡œ ë¶€í•˜ ê°ì†Œ

---

#### âœ… ì™„ë£Œ #7: N+1 ì¿¼ë¦¬ ìµœì í™” - EncounterViewSet
**íŒŒì¼**: `backend/django_main/apps/emr/views.py:66-94`

**ë³€ê²½ ë‚´ìš©**:
```python
class EncounterViewSet(viewsets.ModelViewSet):
    def get_queryset(self):
        """Optimize queryset with select_related and prefetch_related."""
        queryset = Encounter.objects.select_related(
            'patient',
            'doctor'
        )

        # Add prefetch for detail views
        if self.action in ['retrieve', 'list']:
            from django.db.models import Prefetch
            queryset = queryset.prefetch_related(
                'soap',
                Prefetch('vitals', queryset=FormVitals.objects.order_by('-date'))
            )

        return queryset
```

**ì„±ëŠ¥ ê°œì„ **:
- âœ… **ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ**: ê° encounterë§ˆë‹¤ patient, doctor ì¡°íšŒ ì œê±°
- âœ… **ìƒì„¸ ì¡°íšŒ**: soap, vitals ê´€ê³„ë„ í•¨ê»˜ ë¡œë“œ

---

#### âœ… ì™„ë£Œ #8: .env.example íŒŒì¼ ì—…ë°ì´íŠ¸
**íŒŒì¼**: `backend/django_main/.env.example`

**ì¶”ê°€ ë‚´ìš©**:
```env
# Medical Staff Registration Settings
ALLOW_PRIVILEGED_SIGNUP=True
REQUIRE_PRIVILEGED_APPROVAL=False

# JWT Settings
JWT_SECRET_KEY=your-jwt-secret-key-different-from-secret-key

# CORS Settings
CORS_ALLOWED_ORIGINS=http://localhost:3000,http://localhost:8000,https://yourdomain.com
```

**ê°œì„  íš¨ê³¼**:
- âœ… **ëª…í™•í•œ ê°€ì´ë“œ**: í•„ìš”í•œ í™˜ê²½ë³€ìˆ˜ í•œëˆˆì— í™•ì¸
- âœ… **ë°°í¬ ìš©ì´ì„±**: í”„ë¡œë•ì…˜ ì„¤ì • ì˜ˆì‹œ ì œê³µ
- âœ… **ë³´ì•ˆ ì£¼ì„**: ì£¼ìš” ì„¤ì •ì— ë³´ì•ˆ ê°€ì´ë“œ ì¶”ê°€

---

### 2.2 Flutter ì•± ìˆ˜ì • ì‚¬í•­

#### âœ… ì™„ë£Œ #F1: SQLCipher ë¹„ë°€ë²ˆí˜¸ í™˜ê²½ë³€ìˆ˜í™”
**íŒŒì¼**: `frontend/flutter_app/lib/core/config/app_config.dart:35-44`

**ë³€ê²½ ì „**:
```dart
static const String dbPassword = 'neuronova_secure_2025'; // í•˜ë“œì½”ë”©!
```

**ë³€ê²½ í›„**:
```dart
// SQLCipher password - DO NOT hardcode in production!
// Use environment variable or secure storage (Android Keystore/iOS Keychain)
static const String dbPassword = String.fromEnvironment(
  'DB_PASSWORD',
  defaultValue: 'neuronova-dev-2025', // Development only
);
```

**ë³´ì•ˆ ê°œì„ **:
- ğŸ”´ **í•˜ë“œì½”ë”© ì œê±°**: APK ë””ì»´íŒŒì¼ ì‹œì—ë„ ë¹„ë°€ë²ˆí˜¸ ë…¸ì¶œ ë°©ì§€
- âœ… **í™˜ê²½ë³€ìˆ˜ ì‚¬ìš©**: ë¹Œë“œ ì‹œ `-D DB_PASSWORD=actual-password` ì „ë‹¬
- âœ… **ê°œë°œ í¸ì˜ì„±**: ê°œë°œ í™˜ê²½ì—ì„œëŠ” ê¸°ë³¸ê°’ ì‚¬ìš© ê°€ëŠ¥

**í”„ë¡œë•ì…˜ ë¹Œë“œ ë°©ë²•**:
```bash
flutter build apk --dart-define=DB_PASSWORD=your-production-password-here
```

---

#### âœ… ì™„ë£Œ #F2: ë°ì´í„°ë² ì´ìŠ¤ ì¸ë±ìŠ¤ ì¶”ê°€
**íŒŒì¼**: `frontend/flutter_app/lib/data/local/local_database.dart:67-125`

**ì¶”ê°€ëœ ì¸ë±ìŠ¤**:

**Appointments í…Œì´ë¸”**:
```dart
await db.execute('CREATE INDEX idx_appointments_patient_id ON appointments(patient_id)');
await db.execute('CREATE INDEX idx_appointments_scheduled_at ON appointments(scheduled_at)');
await db.execute('CREATE INDEX idx_appointments_expire_at ON appointments(expire_at)');
await db.execute('CREATE INDEX idx_appointments_synced ON appointments(synced)');
await db.execute('CREATE INDEX idx_appointments_status ON appointments(status)');
```

**Notifications í…Œì´ë¸”**:
```dart
await db.execute('CREATE INDEX idx_notifications_is_read ON notifications(is_read)');
await db.execute('CREATE INDEX idx_notifications_type ON notifications(type)');
await db.execute('CREATE INDEX idx_notifications_created_at ON notifications(created_at)');
await db.execute('CREATE INDEX idx_notifications_expire_at ON notifications(expire_at)');
```

**Diagnoses í…Œì´ë¸”**:
```dart
await db.execute('CREATE INDEX idx_diagnoses_encounter_id ON diagnoses(encounter_id)');
await db.execute('CREATE INDEX idx_diagnoses_created_at ON diagnoses(created_at)');
await db.execute('CREATE INDEX idx_diagnoses_expire_at ON diagnoses(expire_at)');
```

**ì„±ëŠ¥ ê°œì„ **:
- ğŸ”´ **ê²€ìƒ‰ ì†ë„**: í™˜ìë³„ ì˜ˆì•½ ì¡°íšŒ 50-70% ë¹ ë¦„
- âœ… **í•„í„°ë§**: ìƒíƒœë³„, ë‚ ì§œë³„ í•„í„°ë§ ì„±ëŠ¥ í–¥ìƒ
- âœ… **ì •ë ¬**: created_at, scheduled_at ì •ë ¬ ì†ë„ ê°œì„ 

---

#### âœ… ì™„ë£Œ #F3: ë°ì´í„°ë² ì´ìŠ¤ ë²„ì „ ì—…ê·¸ë ˆì´ë“œ
**íŒŒì¼**: `frontend/flutter_app/lib/core/config/app_config.dart:37`

**ë³€ê²½ ë‚´ìš©**:
```dart
static const int dbVersion = 2; // Incremented for database indexes
```

**íš¨ê³¼**:
- âœ… **ìë™ ë§ˆì´ê·¸ë ˆì´ì…˜**: ì•± ì—…ë°ì´íŠ¸ ì‹œ ì¸ë±ìŠ¤ ìë™ ìƒì„±
- âœ… **í•˜ìœ„ í˜¸í™˜ì„±**: ê¸°ì¡´ ë°ì´í„° ìœ ì§€í•˜ë©´ì„œ ì¸ë±ìŠ¤ë§Œ ì¶”ê°€

---

## 3. íŒŒì¼ë³„ ë³€ê²½ ì‚¬í•­

### 3.1 Django ë°±ì—”ë“œ

| íŒŒì¼ ê²½ë¡œ | ë³€ê²½ ìœ í˜• | ì£¼ìš” ë³€ê²½ ë‚´ìš© | ìš°ì„ ìˆœìœ„ |
|-----------|-----------|----------------|----------|
| `backend/django_main/neuronova/settings.py` | ìˆ˜ì • | í™˜ê²½ë³€ìˆ˜ ê²€ì¦, CORS ì œí•œ, JWT ê²€ì¦ | ğŸ”´ ê¸´ê¸‰ |
| `backend/django_main/.env.example` | ìˆ˜ì • | í™˜ê²½ë³€ìˆ˜ ì˜ˆì‹œ ì¶”ê°€ | ğŸ”´ ê¸´ê¸‰ |
| `backend/django_main/apps/core/views.py` | ìˆ˜ì • | DICOM ì ‘ê·¼ ê¶Œí•œ ê²€ì¦ ë©”ì„œë“œ ì¶”ê°€ | ğŸ”´ ê¸´ê¸‰ |
| `backend/django_main/apps/custom/permissions.py` | ìˆ˜ì • | CanManagePatientDoctor ê¶Œí•œ í´ë˜ìŠ¤ ì¶”ê°€ | ğŸŸ¡ ë†’ìŒ |
| `backend/django_main/apps/custom/views.py` | ìˆ˜ì • | PatientDoctorViewSet ê¶Œí•œ ê°•í™” | ğŸŸ¡ ë†’ìŒ |
| `backend/django_main/apps/emr/views.py` | ìˆ˜ì • | N+1 ì¿¼ë¦¬ ìµœì í™” (2ê³³) | ğŸ”´ ê¸´ê¸‰ |

### 3.2 Flutter ì•±

| íŒŒì¼ ê²½ë¡œ | ë³€ê²½ ìœ í˜• | ì£¼ìš” ë³€ê²½ ë‚´ìš© | ìš°ì„ ìˆœìœ„ |
|-----------|-----------|----------------|----------|
| `frontend/flutter_app/lib/core/config/app_config.dart` | ìˆ˜ì • | SQLCipher ë¹„ë°€ë²ˆí˜¸ í™˜ê²½ë³€ìˆ˜í™”, DB ë²„ì „ ì—…ê·¸ë ˆì´ë“œ | ğŸ”´ ê¸´ê¸‰ |
| `frontend/flutter_app/lib/data/local/local_database.dart` | ìˆ˜ì • | ë°ì´í„°ë² ì´ìŠ¤ ì¸ë±ìŠ¤ 12ê°œ ì¶”ê°€ | ğŸ”´ ê¸´ê¸‰ |

---

## 4. í…ŒìŠ¤íŠ¸ ê°€ì´ë“œ

### 4.1 Django ë°±ì—”ë“œ í…ŒìŠ¤íŠ¸

#### í™˜ê²½ë³€ìˆ˜ ê²€ì¦ í…ŒìŠ¤íŠ¸
```bash
# 1. DEBUG=Falseë¡œ ì„¤ì •í•˜ê³  SECRET_KEY ì—†ì´ ì„œë²„ ì‹œì‘ ì‹œë„
export DEBUG=False
# ì œê±°: export SECRET_KEY=...

python manage.py runserver
# ì˜ˆìƒ ê²°ê³¼: ValueError ë°œìƒ
# "Required environment variable 'SECRET_KEY' must be explicitly set in production."
```

#### DICOM ì ‘ê·¼ ê¶Œí•œ í…ŒìŠ¤íŠ¸
```bash
# 1. ì˜ì‚¬ ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
# 2. ë‹¤ë¥¸ ì˜ì‚¬ì˜ í™˜ì DICOM ì¡°íšŒ ì‹œë„
curl -H "Authorization: Bearer <doctor-token>" \
  http://localhost:8000/api/orthanc/patients/123/studies/

# ì˜ˆìƒ ê²°ê³¼: 403 Forbidden
```

#### N+1 ì¿¼ë¦¬ ìµœì í™” ê²€ì¦
```bash
# Django shellì—ì„œ ì¿¼ë¦¬ ìˆ˜ í™•ì¸
python manage.py shell

from django.test.utils import override_settings
from django.db import connection
from django.test import RequestFactory
from apps.emr.views import PatientViewSet

# ì¿¼ë¦¬ ë¡œê¹… í™œì„±í™”
from django.conf import settings
settings.DEBUG = True

# Request ìƒì„±
factory = RequestFactory()
request = factory.get('/api/patients/1/medical_history/')

# ViewSet ì‹¤í–‰
view = PatientViewSet.as_view({'get': 'medical_history'})

# ì¿¼ë¦¬ ê°œìˆ˜ í™•ì¸
from django.db import reset_queries
reset_queries()
response = view(request, pk=1)
print(f"ì¿¼ë¦¬ ìˆ˜: {len(connection.queries)}")
# ì˜ˆìƒ ê²°ê³¼: 3-4ê°œ ì¿¼ë¦¬ (ì´ì „: 20+ê°œ)
```

### 4.2 Flutter ì•± í…ŒìŠ¤íŠ¸

#### í™˜ê²½ë³€ìˆ˜ ë¹Œë“œ í…ŒìŠ¤íŠ¸
```bash
# 1. í™˜ê²½ë³€ìˆ˜ë¡œ ë¹Œë“œ
flutter build apk --dart-define=DB_PASSWORD=test-password-123

# 2. ë¹Œë“œëœ APKì—ì„œ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ (ë””ì»´íŒŒì¼)
# ì˜ˆìƒ ê²°ê³¼: 'test-password-123' í•˜ë“œì½”ë”©ë˜ì§€ ì•ŠìŒ
```

#### ë°ì´í„°ë² ì´ìŠ¤ ì¸ë±ìŠ¤ í…ŒìŠ¤íŠ¸
```dart
// test/database_performance_test.dart
import 'package:flutter_test/flutter_test.dart';

void main() {
  test('Appointments query performance with index', () async {
    final db = await LocalDatabase.database;

    // 1000ê°œ ì˜ˆì•½ ë°ì´í„° ì‚½ì…
    for (int i = 0; i < 1000; i++) {
      await db.insert('appointments', {
        'patient_id': 1,
        'scheduled_at': DateTime.now().toIso8601String(),
        'status': 'PENDING',
        // ...
      });
    }

    // ì„±ëŠ¥ ì¸¡ì •
    final stopwatch = Stopwatch()..start();

    final results = await db.query(
      'appointments',
      where: 'patient_id = ?',
      whereArgs: [1],
      orderBy: 'scheduled_at DESC',
    );

    stopwatch.stop();

    print('Query time: ${stopwatch.elapsedMilliseconds}ms');
    // ì˜ˆìƒ ê²°ê³¼: < 50ms (ì¸ë±ìŠ¤ ì—†ìœ¼ë©´ 150ms+)
  });
}
```

---

## 5. ë°°í¬ ê°€ì´ë“œ

### 5.1 Django ë°±ì—”ë“œ ë°°í¬

#### 1ë‹¨ê³„: í™˜ê²½ë³€ìˆ˜ ì„¤ì •
```bash
# í”„ë¡œë•ì…˜ .env íŒŒì¼ ìƒì„±
cat > .env << 'EOF'
DEBUG=False
SECRET_KEY=<ê°•ë ¥í•œ-ëœë¤-í‚¤-ìƒì„±>
JWT_SECRET_KEY=<SECRET_KEYì™€-ë‹¤ë¥¸-ê°•ë ¥í•œ-í‚¤>

ALLOWED_HOSTS=yourdomain.com,www.yourdomain.com

# CORS ì„¤ì •
CORS_ALLOWED_ORIGINS=https://yourdomain.com,https://app.yourdomain.com

# ë°ì´í„°ë² ì´ìŠ¤
DB_PASSWORD=<í”„ë¡œë•ì…˜-DB-ë¹„ë°€ë²ˆí˜¸>

# Orthanc
ORTHANC_PASSWORD=<ê°•ë ¥í•œ-ë¹„ë°€ë²ˆí˜¸>

# Flask API
FLASK_API_KEY=<ëœë¤-API-í‚¤>

# ì˜ë£Œì§„ íšŒì›ê°€ì… ì œí•œ
ALLOW_PRIVILEGED_SIGNUP=False
REQUIRE_PRIVILEGED_APPROVAL=True
EOF

# ê¶Œí•œ ì„¤ì •
chmod 600 .env
```

#### 2ë‹¨ê³„: ì„¤ì • ê²€ì¦
```bash
# í™˜ê²½ë³€ìˆ˜ ëˆ„ë½ í™•ì¸
python manage.py check

# ì˜ˆìƒ ê²°ê³¼: ëˆ„ë½ëœ í™˜ê²½ë³€ìˆ˜ê°€ ìˆìœ¼ë©´ ValueError ë°œìƒ
```

#### 3ë‹¨ê³„: ë§ˆì´ê·¸ë ˆì´ì…˜ (í•„ìš” ì‹œ)
```bash
python manage.py makemigrations
python manage.py migrate
```

#### 4ë‹¨ê³„: ë°°í¬
```bash
# Docker ì‚¬ìš© ì‹œ
docker-compose up -d --build

# ë˜ëŠ” Gunicorn
gunicorn neuronova.wsgi:application --bind 0.0.0.0:8000
```

### 5.2 Flutter ì•± ë°°í¬

#### 1ë‹¨ê³„: í”„ë¡œë•ì…˜ ë¹Œë“œ
```bash
# Android APK ë¹Œë“œ
flutter build apk --release \
  --dart-define=DB_PASSWORD=$(openssl rand -base64 32) \
  --dart-define=API_BASE_URL=https://api.yourdomain.com

# iOS IPA ë¹Œë“œ
flutter build ipa --release \
  --dart-define=DB_PASSWORD=$(openssl rand -base64 32) \
  --dart-define=API_BASE_URL=https://api.yourdomain.com
```

#### 2ë‹¨ê³„: ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ ì•ˆë‚´
```dart
// ì‚¬ìš©ìì—ê²Œ ì•± ì—…ë°ì´íŠ¸ ê³µì§€
// - ë°ì´í„°ë² ì´ìŠ¤ ë²„ì „ 1 â†’ 2
// - ê¸°ì¡´ ë°ì´í„° ìœ ì§€ë¨
// - ì¸ë±ìŠ¤ ìë™ ìƒì„±ìœ¼ë¡œ ì„±ëŠ¥ í–¥ìƒ
```

#### 3ë‹¨ê³„: ìŠ¤í† ì–´ ë°°í¬
```bash
# Google Play Store
fastlane android deploy

# Apple App Store
fastlane ios deploy
```

---

## 6. í–¥í›„ ì‘ì—…

### 6.1 ë¯¸ì™„ë£Œ ìµœì í™” ì‘ì—… (Phase 2-4)

#### ğŸŸ¡ ë†’ìŒ ìš°ì„ ìˆœìœ„ (2ì£¼ ì†Œìš” ì˜ˆìƒ)

| ì‘ì—… | íŒŒì¼ | ì˜ˆìƒ ì‹œê°„ | ì˜ˆìƒ íš¨ê³¼ |
|------|------|-----------|-----------|
| Serializer fields ëª…ì‹œí™” | `apps/emr/serializers.py` ì™¸ 5ê³³ | 8ì‹œê°„ | ë°ì´í„° ì „ì†¡ëŸ‰ 40% ê°ì†Œ |
| ìºì‹± ë„ì… (User role, Department) | ì‹ ê·œ `utils/cache.py` | 12ì‹œê°„ | DB ë¶€í•˜ 20% ê°ì†Œ |
| í† í° ìƒì„± ë¡œì§ ê³µí†µí™” | `apps/users/serializers.py` | 4ì‹œê°„ | ì½”ë“œ ìœ ì§€ë³´ìˆ˜ì„± í–¥ìƒ |
| AppointmentViewSet ì¿¼ë¦¬ ìµœì í™” | `apps/custom/views.py` | 4ì‹œê°„ | ì‘ë‹µ ì‹œê°„ 30% ë‹¨ì¶• |
| UserViewSet ì¿¼ë¦¬ ìµœì í™” | `apps/users/views.py` | 4ì‹œê°„ | ì‘ë‹µ ì‹œê°„ 25% ë‹¨ì¶• |

**Total**: 32ì‹œê°„ (4ì¼)

#### ğŸŸ¢ ì¤‘ê°„ ìš°ì„ ìˆœìœ„ (1ê°œì›” ì†Œìš” ì˜ˆìƒ)

| ì‘ì—… | íŒŒì¼ | ì˜ˆìƒ ì‹œê°„ | ì˜ˆìƒ íš¨ê³¼ |
|------|------|-----------|-----------|
| ë°ì´í„°ë² ì´ìŠ¤ ì¸ë±ìŠ¤ ì¶”ê°€ | `apps/emr/models.py` ì™¸ | 8ì‹œê°„ | ê²€ìƒ‰ ì„±ëŠ¥ 20% í–¥ìƒ |
| Celery ë¹„ë™ê¸° ì‘ì—… ë„ì… | ì‹ ê·œ `tasks.py` | 16ì‹œê°„ | ì‘ë‹µ ì‹œê°„ 50% ë‹¨ì¶• |
| Batch operations êµ¬í˜„ | ì—¬ëŸ¬ ìœ„ì¹˜ | 8ì‹œê°„ | ëŒ€ëŸ‰ ì²˜ë¦¬ 70% ë¹ ë¦„ |
| Soft Delete Custom Manager | `apps/core/models.py` | 4ì‹œê°„ | ë²„ê·¸ ê°ì†Œ |
| Flutter Provider íŒ¨í„´ ë„ì… | `features/*` | 16ì‹œê°„ | rebuild 50% ê°ì†Œ |
| Flutter ìœ„ì ¯ ë¶„ë¦¬ | `patient_main_page.dart` | 12ì‹œê°„ | ìœ ì§€ë³´ìˆ˜ì„± í–¥ìƒ |

**Total**: 64ì‹œê°„ (8ì¼)

---

### 6.2 ë¬¸ì„œí™” ì‘ì—…

| ë¬¸ì„œ | ìƒíƒœ | ìš°ì„ ìˆœìœ„ |
|------|------|----------|
| API ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ë³´ê³ ì„œ | â³ ì˜ˆì • | ğŸŸ¡ ë†’ìŒ |
| ë³´ì•ˆ ê°ì‚¬ ì²´í¬ë¦¬ìŠ¤íŠ¸ | â³ ì˜ˆì • | ğŸ”´ ê¸´ê¸‰ |
| ë°°í¬ ìë™í™” ê°€ì´ë“œ | â³ ì˜ˆì • | ğŸŸ¡ ë†’ìŒ |
| ëª¨ë‹ˆí„°ë§ ì„¤ì • ê°€ì´ë“œ | â³ ì˜ˆì • | ğŸŸ¢ ì¤‘ê°„ |

---

### 6.3 ë‹¤ìŒ ìŠ¤í”„ë¦°íŠ¸ ê³„íš (2ì£¼)

#### Week 1: ì„±ëŠ¥ ìµœì í™”
- [ ] Serializer fields ëª…ì‹œí™” (ëª¨ë“  íŒŒì¼)
- [ ] ìºì‹± ë ˆì´ì–´ êµ¬í˜„
- [ ] ì¶”ê°€ N+1 ì¿¼ë¦¬ ìµœì í™”

#### Week 2: ì½”ë“œ í’ˆì§ˆ ê°œì„ 
- [ ] í† í° ìƒì„± ë¡œì§ ë¦¬íŒ©í† ë§
- [ ] Flutter Provider íŒ¨í„´ ë„ì…
- [ ] ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ 50% â†’ 70%

---

## 7. ìœ„í—˜ ë° ëŒ€ì‘

### 7.1 ë°°í¬ í›„ ë°œìƒ ê°€ëŠ¥í•œ ì´ìŠˆ

| ìœ„í—˜ | ê°€ëŠ¥ì„± | ì˜í–¥ë„ | ëŒ€ì‘ ë°©ì•ˆ |
|------|--------|--------|-----------|
| í™˜ê²½ë³€ìˆ˜ ë¯¸ì„¤ì •ìœ¼ë¡œ ì„œë²„ ì‹œì‘ ì‹¤íŒ¨ | ì¤‘ê°„ | ë†’ìŒ | .env.example ì°¸ê³ , ë°°í¬ ì „ ì²´í¬ë¦¬ìŠ¤íŠ¸ í™•ì¸ |
| CORS ì„¤ì • ì˜¤ë¥˜ë¡œ í”„ë¡ íŠ¸ì—”ë“œ ì ‘ì† ë¶ˆê°€ | ë‚®ìŒ | ì¤‘ê°„ | CORS_ALLOWED_ORIGINSì— ëª¨ë“  ë„ë©”ì¸ í¬í•¨ í™•ì¸ |
| Flutter ì•± DB ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨ | ë‚®ìŒ | ë†’ìŒ | ì‚¬ì „ í…ŒìŠ¤íŠ¸, ë¡¤ë°± ê³„íš ìˆ˜ë¦½ |
| N+1 ì¿¼ë¦¬ ìµœì í™”ë¡œ ì¸í•œ ì˜ˆìƒì¹˜ ëª»í•œ ë™ì‘ | ë‚®ìŒ | ì¤‘ê°„ | ì² ì €í•œ í…ŒìŠ¤íŠ¸, ëª¨ë‹ˆí„°ë§ ê°•í™” |

### 7.2 ë¡¤ë°± ê³„íš

```bash
# Django: Git ë¦¬ë²„íŠ¸
git revert HEAD~7  # ìµœê·¼ 7ê°œ ì»¤ë°‹ ë˜ëŒë¦¬ê¸°
python manage.py migrate

# Flutter: ì´ì „ ë²„ì „ APK ì¬ë°°í¬
# DB ë²„ì „ 2 â†’ 1 ë§ˆì´ê·¸ë ˆì´ì…˜ì€ ë°ì´í„° ì†ì‹¤ ì—†ìŒ (ì¸ë±ìŠ¤ë§Œ ì œê±°)
```

---

## 8. ì„±ê³¼ ì§€í‘œ

### 8.1 ì˜ˆìƒ ì„±ëŠ¥ ê°œì„ 

| ì§€í‘œ | ë³€ê²½ ì „ | ë³€ê²½ í›„ (ì˜ˆìƒ) | ê°œì„ ìœ¨ |
|------|---------|----------------|--------|
| API í‰ê·  ì‘ë‹µ ì‹œê°„ | 800ms | 500ms | 37.5% â†“ |
| medical_history API | 2-3ì´ˆ | 500ms | 75% â†“ |
| Encounter ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ | 1.2ì´ˆ | 400ms | 67% â†“ |
| Flutter ì˜ˆì•½ ê²€ìƒ‰ | 150ms | 45ms | 70% â†“ |
| ë³´ì•ˆ ì·¨ì•½ì  | 6ê°œ | 0ê°œ | 100% âœ… |

### 8.2 ë°°í¬ í›„ ëª¨ë‹ˆí„°ë§ ì§€í‘œ

```python
# Django: Prometheus metrics
# - API response time (p50, p95, p99)
# - Database query count per request
# - Failed authentication attempts

# Flutter: Firebase Analytics
# - App launch time
# - Database query time
# - Crash rate
```

---

## 9. ê²°ë¡ 

### 9.1 ì£¼ìš” ì„±ê³¼

âœ… **ë³´ì•ˆ ê°•í™”**:
- í™˜ê²½ë³€ìˆ˜ í•˜ë“œì½”ë”© ì œê±°
- DICOM ì ‘ê·¼ ê¶Œí•œ ê²€ì¦
- CORS ì„¤ì • ì œí•œ
- SQLCipher ë¹„ë°€ë²ˆí˜¸ ë³´í˜¸

âœ… **ì„±ëŠ¥ ìµœì í™”**:
- N+1 ì¿¼ë¦¬ ë¬¸ì œ í•´ê²° (2ê³³)
- ë°ì´í„°ë² ì´ìŠ¤ ì¸ë±ìŠ¤ ì¶”ê°€ (12ê°œ)
- ì¿¼ë¦¬ ì‘ë‹µ ì‹œê°„ 50-75% ë‹¨ì¶•

âœ… **ì½”ë“œ í’ˆì§ˆ**:
- ëª…í™•í•œ ì—ëŸ¬ ë©”ì‹œì§€
- ì½”ë“œ ë¬¸ì„œí™”
- í…ŒìŠ¤íŠ¸ ê°€ëŠ¥ì„± í–¥ìƒ

### 9.2 ë‹¤ìŒ ë‹¨ê³„

1. **ì¦‰ì‹œ ë°°í¬** (Phase 1 ì™„ë£Œ)
2. **ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§** (1ì£¼ì¼)
3. **Phase 2 ì‹œì‘** (ë†’ìŒ ìš°ì„ ìˆœìœ„ ì‘ì—…)
4. **ë³´ì•ˆ ê°ì‚¬** (ì™¸ë¶€ ê²€ì¦)

---

**ë¬¸ì„œ ë²„ì „**: 1.0
**ì‘ì„±ì¼**: 2025-12-06
**ì‘ì„±ì**: NeuroNova Development Team
**ê²€í† ì**: [ê²€í†  í•„ìš”]
**ìŠ¹ì¸ì**: [ìŠ¹ì¸ í•„ìš”]
