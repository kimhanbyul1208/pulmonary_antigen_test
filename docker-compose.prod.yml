# NeuroNova 프로덕션 배포용 Docker Compose
# 사용법: docker-compose -f docker-compose.prod.yml up -d

version: '3.8'

networks:
  neuronova_network:
    driver: bridge

volumes:
  mysql_data:
    driver: local
  redis_data:
    driver: local
  orthanc_data:
    driver: local
  static_files:
    driver: local
  media_files:
    driver: local
  certbot_conf:
    driver: local
  certbot_www:
    driver: local

services:
  # MySQL 데이터베이스
  db:
    image: mysql:8.0
    container_name: neuronova_db
    restart: always
    volumes:
      - mysql_data:/var/lib/mysql
      - ./config/mysql/my.cnf:/etc/mysql/conf.d/my.cnf:ro
    environment:
      - MYSQL_DATABASE=${DB_NAME}
      - MYSQL_USER=${DB_USER}
      - MYSQL_PASSWORD=${DB_PASSWORD}
      - MYSQL_ROOT_PASSWORD=${DB_ROOT_PASSWORD}
      - TZ=Asia/Seoul
    networks:
      - neuronova_network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Redis 캐시
  redis:
    image: redis:7-alpine
    container_name: neuronova_redis
    restart: always
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
    networks:
      - neuronova_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Orthanc DICOM 서버
  orthanc:
    image: jodogne/orthanc:latest
    container_name: neuronova_orthanc
    restart: always
    volumes:
      - orthanc_data:/var/lib/orthanc/db
      - ./config/orthanc/orthanc.json:/etc/orthanc/orthanc.json:ro
    environment:
      - ORTHANC_NAME=NeuroNovaOrthanc
      - ORTHANC_USERNAME=${ORTHANC_USERNAME}
      - ORTHANC_PASSWORD=${ORTHANC_PASSWORD}
    networks:
      - neuronova_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8042/system"]
      interval: 30s
      timeout: 5s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Django 백엔드
  django:
    build:
      context: ./backend/django_main
      dockerfile: Dockerfile.prod
    container_name: neuronova_django
    restart: always
    volumes:
      - static_files:/app/staticfiles
      - media_files:/app/media
      - ./backend/django_main/logs:/app/logs
    environment:
      - DJANGO_SETTINGS_MODULE=neuronova.settings
      - SECRET_KEY=${DJANGO_SECRET_KEY}
      - DEBUG=False
      - ALLOWED_HOSTS=${ALLOWED_HOSTS}

      # Database
      - DB_ENGINE=django.db.backends.mysql
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_HOST=db
      - DB_PORT=3306

      # Redis
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}

      # External Services
      - ORTHANC_URL=http://orthanc:8042
      - ORTHANC_USERNAME=${ORTHANC_USERNAME}
      - ORTHANC_PASSWORD=${ORTHANC_PASSWORD}
      - FLASK_INFERENCE_URL=http://flask:5000

      # Firebase
      - FIREBASE_CREDENTIALS_PATH=/app/config/firebase-service-account.json

      # Project
      - PROJECT_NAME=NeuroNova
      - PROJECT_VERSION=1.0.0
      - API_VERSION=v1
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - neuronova_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health/"]
      interval: 30s
      timeout: 5s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Flask AI 추론 서버
  flask:
    build:
      context: ./backend/flask_inference
      dockerfile: Dockerfile.prod
    container_name: neuronova_flask
    restart: always
    volumes:
      - ./backend/flask_inference/models:/app/models:ro
      - ./backend/flask_inference/logs:/app/logs
    environment:
      - FLASK_ENV=production
      - DJANGO_API_URL=http://django:8000
      - MODEL_PATH=/app/models
    depends_on:
      - django
    networks:
      - neuronova_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 5s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    # GPU 사용 시 (NVIDIA Docker 필요)
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]

  # React 웹 프론트엔드
  react:
    build:
      context: ./frontend/react_web
      dockerfile: Dockerfile.prod
      args:
        - VITE_API_BASE_URL=${REACT_API_BASE_URL}
        - VITE_ORTHANC_URL=${REACT_ORTHANC_URL}
    container_name: neuronova_react
    restart: always
    networks:
      - neuronova_network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Nginx 리버스 프록시
  nginx:
    build:
      context: ./config/nginx
      dockerfile: Dockerfile
    container_name: neuronova_nginx
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - static_files:/app/staticfiles:ro
      - media_files:/app/media:ro
      - certbot_conf:/etc/letsencrypt
      - certbot_www:/var/www/certbot
      - ./config/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - django
      - flask
      - react
      - orthanc
    networks:
      - neuronova_network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 3s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Certbot (SSL 인증서 자동 갱신)
  certbot:
    image: certbot/certbot:latest
    container_name: neuronova_certbot
    restart: unless-stopped
    volumes:
      - certbot_conf:/etc/letsencrypt
      - certbot_www:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
    networks:
      - neuronova_network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
